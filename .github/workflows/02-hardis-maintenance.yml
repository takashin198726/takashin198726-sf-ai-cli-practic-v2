name: sfdx-hardis Maintenance

on:
  schedule:
    # Every Monday at 9:00 AM JST (00:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  maintenance:
    name: Project Maintenance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli
      
      - name: Install sfdx-hardis
        run: sf plugins install sfdx-hardis
      
      - name: Authenticate with Salesforce
        run: |
          echo "${{ secrets.SERVER_KEY_BASE64 }}" | base64 -d > server.key
          sf org login jwt \
            --client-id "${{ secrets.SF_CONSUMER_KEY }}" \
            --jwt-key-file server.key \
            --username "${{ secrets.SF_USERNAME }}" \
            --instance-url "${{ secrets.SF_INSTANCE_URL }}" \
            --alias maintenance-org \
            --set-default
          rm server.key
      
      - name: Generate project documentation
        continue-on-error: true
        run: |
          mkdir -p docs/generated
          sf hardis:doc:project2markdown \
            --output-dir docs/generated \
            --target-org maintenance-org || echo "âš ï¸ Documentation generation failed"
      
      - name: Detect unused metadata
        continue-on-error: true
        run: |
          mkdir -p docs/generated
          sf hardis:lint:unusedmetadatas \
            --target-org maintenance-org \
            --output-file docs/generated/unused-metadata.md || echo "âš ï¸ Unused metadata detection failed"
      
      - name: Check for changes
        id: check_changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No documentation changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Documentation changes detected"
          fi
      
      - name: Create PR with updates
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs: Update generated documentation [automated]'
          title: 'ğŸ¤– Automated Documentation Update'
          body: |
            ## Automated Maintenance
            
            This PR contains automated updates from sfdx-hardis:
            - ğŸ“š Project documentation regenerated
            - ğŸ” Unused metadata detection results
            
            **Generated by:** sfdx-hardis Maintenance Workflow
            **Timestamp:** ${{ github.run_id }}
            
            Please review and merge if appropriate.
          branch: automated/hardis-maintenance-${{ github.run_id }}
          delete-branch: true
          labels: |
            automated
            documentation
