name: PR Validation

on:
  pull_request:
    branches: [main, develop]

jobs:
  file-count-check:
    name: Check PR File Count
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check file count
        id: file_count
        run: |
          FILE_COUNT=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "Files changed: $FILE_COUNT"
          
          if [ $FILE_COUNT -gt 80 ]; then
            echo "⚠️  WARNING: PR contains $FILE_COUNT files (limit: 80)"
            echo "Consider splitting this PR for better CodeRabbit review quality"
            exit 1
          fi
          
  validate:
    name: Validate Salesforce Metadata
    runs-on: ubuntu-latest
    needs: file-count-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli
      
      - name: Install sfdx-hardis
        run: sf plugins install sfdx-hardis
        
      - name: Install sfdx-git-delta
        run: echo "y" | sf plugins install sfdx-git-delta
      
      - name: Authenticate with Salesforce (JWT)
        run: |
          echo "${{ secrets.SERVER_KEY_BASE64 }}" | base64 -d > server.key
          sf org login jwt \
            --client-id "${{ secrets.SF_CONSUMER_KEY }}" \
            --jwt-key-file server.key \
            --username "${{ secrets.SF_USERNAME }}" \
            --instance-url "${{ secrets.SF_INSTANCE_URL }}" \
            --alias validation-org \
            --set-default
          rm server.key
      
      - name: Run PMD static analysis
        run: |
          sf scanner run \
            --target "force-app" \
            --pmdconfig config/pmd-ruleset.xml \
            --format table \
            --severity-threshold 3
      
      - name: Run ESLint
        run: npm run lint
        
      - name: Run Apex tests
        run: |
          sf apex run test \
            --test-level RunLocalTests \
            --code-coverage \
            --result-format human \
            --wait 20
      
      - name: Check-only deployment
        run: |
          sf project deploy start \
            --check-only \
            --test-level RunLocalTests \
            --wait 20
